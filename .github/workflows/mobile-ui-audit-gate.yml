name: Mobile UI Audit Gate

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  create:
    tags:
      - '*'

jobs:
  mobile-ui-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect mobile UI changes
        id: mobile_changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep -q '^frontend/screens/mobile/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate mobile UI audit
        if: steps.mobile_changes.outputs.changed == 'true'
        run: |
          AUDIT_FILE="docs/mobile/audit/mobile-ui-audit.latest.yaml"
          CHECKLIST="docs/mobile/MOBILE_UI_AUDIT_CHECKLIST.md"

          [ -f "$AUDIT_FILE" ] || exit 1

          RESULT=$(grep '^ *result:' "$AUDIT_FILE" | awk '{print $2}')
          COMMIT=$(grep '^ *commit:' "$AUDIT_FILE" | awk '{print $2}')

          [ "$RESULT" = "PASS" ] || exit 1
          [ "$COMMIT" = "$(git rev-parse HEAD)" ] || exit 1

          CHECKSUM_CURRENT=$(sha256sum "$CHECKLIST" | awk '{print $1}')
          CHECKSUM_AUDIT=$(grep '^ *checksum:' "$AUDIT_FILE" | awk '{print $2}')

          [ "$CHECKSUM_CURRENT" = "$CHECKSUM_AUDIT" ] || exit 1

  desktop-recovery-ui-audit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - run: |
          if git diff --name-only origin/main...HEAD | grep -q '^frontend/screens/recovery/'; then
            AUDIT="docs/desktop/audit/desktop-recovery-ui-audit.latest.yaml"
            [ -f "$AUDIT" ] || exit 1
            grep -q 'result: PASS' "$AUDIT" || exit 1
          fi
