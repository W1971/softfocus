name: Mobile UI Audit Gate

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  mobile-ui-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect mobile UI changes
        id: mobile_changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep -q '^frontend/screens/mobile/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip audit (no mobile changes)
        if: steps.mobile_changes.outputs.changed == 'false'
        run: |
          echo "No mobile UI changes detected. Audit gate skipped."

      - name: Validate mobile UI audit
        if: steps.mobile_changes.outputs.changed == 'true'
        run: |
          AUDIT_FILE="docs/mobile/audit/mobile-ui-audit.latest.yaml"
          CHECKLIST="docs/mobile/MOBILE_UI_AUDIT_CHECKLIST.md"

          if [ ! -f "$AUDIT_FILE" ]; then
            echo "❌ Missing mobile UI audit file"
            exit 1
          fi

          RESULT=$(grep '^ *result:' "$AUDIT_FILE" | awk '{print $2}')
          COMMIT=$(grep '^ *commit:' "$AUDIT_FILE" | awk '{print $2}')

          if [ "$RESULT" != "PASS" ]; then
            echo "❌ Mobile UI audit result is not PASS"
            exit 1
          fi

          if [ "$COMMIT" != "$(git rev-parse HEAD)" ]; then
            echo "❌ Audit commit does not match HEAD"
            exit 1
          fi

          CHECKSUM_CURRENT=$(sha256sum "$CHECKLIST" | awk '{print $1}')
          CHECKSUM_AUDIT=$(grep '^ *checksum:' "$AUDIT_FILE" | awk '{print $2}')

          if [ "$CHECKSUM_CURRENT" != "$CHECKSUM_AUDIT" ]; then
            echo "❌ Checklist checksum mismatch"
            exit 1
          fi

          echo "✅ Mobile UI audit PASS — gate satisfied"
