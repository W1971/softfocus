#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
BIN_DIR="$ROOT/alias_softfocus/bin"
STATUS_DIR="$ROOT/alias_softfocus/status"
DOCS_DIR="$ROOT/docs"

is_ci() {
  [ "${CI:-0}" = "true" ] || [ "${CI:-0}" = "1" ]
}

read_status() {
  local name="$1"
  local f="$STATUS_DIR/$name.status"
  if [ -f "$f" ]; then
    awk '/derived_state/ {print $2}' "$f"
  else
    echo "UNKNOWN"
  fi
}

gate_or_die() {
  local name="$1"
  local state
  state="$(read_status "$name")"

  if [ "$state" = "READY" ]; then
    return 0
  fi

  if is_ci; then
    echo "❌ CI BLOCK: '$name' status=$state"
    exit 1
  fi

  if [ "${FORCE:-0}" = "1" ]; then
    echo "⚠️  FORCED RUN: '$name' status=$state"
    return 0
  fi

  echo "❌ BLOCKED: '$name' status=$state"
  echo "Hint: run with FORCE=1 to override locally"
  exit 1
}

run_cmd() {
  local name="$1"; shift
  gate_or_die "$name"
  "$BIN_DIR/$name" "$@"
}

list_cmd() {
  echo "Available SoftFocus commands:"
  for f in "$BIN_DIR"/*; do
    [ -x "$f" ] || continue
    name="$(basename "$f")"
    [ "$name" = "alias-softfocus" ] && continue
    state="$(read_status "$name")"
    echo "  $name [$state]"
  done
}

docs_overview() {
  echo "SoftFocus Documentation Layers"
  echo "=============================="
  echo
  for layer in control frontend business governance internal engineering operations policy releases; do
    [ -d "$DOCS_DIR/$layer" ] || continue
    count="$(find "$DOCS_DIR/$layer" -type f | wc -l | tr -d ' ')"
    printf "%-12s %s files\n" "$layer/" "$count"
  done
  echo
  echo "Entry point: docs/README.md"
}

docs_cmd() { docs_overview; }

explain_cmd() {
  case "${1:-}" in
    docs)
      cat <<'TXT'
alias-softfocus docs
- Overview of documentation layers
- Used as CI and pre-commit smoke-test
TXT
      ;;
    *)
      echo "No explanation available"
      ;;
  esac
}

doctor_cmd() {
  echo "Running SoftFocus diagnostics..."
  [ -d "$DOCS_DIR" ] && echo "✔ docs present"
  [ -d "$STATUS_DIR" ] && echo "✔ status dir present"
}

case "${1:-}" in
  list)
    list_cmd
    ;;
  run)
    shift
    name="${1:-}"; shift || true
    [ -z "$name" ] && { echo "Usage: alias-softfocus run <command>"; exit 1; }
    run_cmd "$name" "$@"
    ;;
  docs)
    docs_cmd
    ;;
  explain)
    shift
    explain_cmd "$@"
    ;;
  doctor)
    doctor_cmd
    ;;
  *)
    echo "Usage: alias-softfocus {list|run|docs|explain|doctor}"
    exit 1
    ;;
esac
