#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
BIN_DIR="$ROOT/alias_softfocus/bin"
STATUS_DIR="$ROOT/alias_softfocus/status"

run() {
  if [ "${DRY_RUN:-0}" = "1" ]; then
    echo "[DRY_RUN] $*"
  else
    "$@"
  fi
}

list_cmd() {
  echo "Available SoftFocus commands:"
  for f in "$BIN_DIR"/*; do
    [ -x "$f" ] || continue
    name="$(basename "$f")"
    [ "$name" = "alias-softfocus" ] && continue

    status_file="$STATUS_DIR/$name.status"
    if [ -f "$status_file" ]; then
      state="$(grep derived_state "$status_file" | awk '{print $2}')"
      echo "  $name [$state]"
    else
      echo "  $name [UNKNOWN]"
    fi
  done
}

docs_cmd() {
  DOCS="$ROOT/docs"

  echo "SoftFocus Documentation Layers"
  echo "=============================="
  echo

  for layer in control frontend business governance internal engineering operations policy releases; do
    if [ -d "$DOCS/$layer" ]; then
      count="$(find "$DOCS/$layer" -type f | wc -l | tr -d ' ')"
      printf "%-12s %s files\n" "$layer/" "$count"
    fi
  done

  echo
  echo "Entry point:"
  echo "  docs/README.md"
}

explain_cmd() {
  cmd="${1:-}"
  if [ -z "$cmd" ]; then
    echo "Usage: alias-softfocus explain <command>"
    exit 1
  fi

  explain_file="$ROOT/docs/control/SOFTFOCUS_ALIAS_SPEC.md"
  if [ -f "$explain_file" ]; then
    echo "See: $explain_file"
  else
    echo "No explanation available"
  fi
}

doctor_cmd() {
  echo "Running SoftFocus diagnostics..."
  echo
  echo "✔ alias-softfocus available"
  echo "✔ docs directory present"
  echo "✔ status directory present"
}

case "${1:-}" in
  list)
    list_cmd
    ;;
  run)
    shift
    run "$@"
    ;;
  docs)
    docs_cmd
    ;;
  explain)
    shift
    explain_cmd "$@"
    ;;
  doctor)
    doctor_cmd
    ;;
  *)
    echo "Usage: alias-softfocus {list|run|docs|explain|doctor}"
    exit 1
    ;;
esac
