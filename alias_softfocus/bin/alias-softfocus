#!/usr/bin/env node

import fs from "fs";
import { spawnSync } from "child_process";
import { resolveAlias } from "../lib/resolve-alias.js";

const [, , subcommand, aliasName, ...args] = process.argv;
const FORCE = process.env.FORCE === "1";

if (!subcommand) {
  usage();
  process.exit(1);
}

switch (subcommand) {
  case "run":
    if (!aliasName) {
      console.error("ERROR: alias name required");
      usage();
      process.exit(1);
    }
    runAlias(aliasName, args);
    break;

  case "list":
    listAliases();
    break;

  case "docs":
    docsStub();
    break;

  default:
    console.error(`ERROR: unknown command '${subcommand}'`);
    usage();
    process.exit(1);
}

function runAlias(alias, args) {
  let hadWarnings = false;

  try {
    const resolved = resolveAlias(alias);

    if (resolved.execution === "RESTRICTED" && !FORCE) {
      console.error(
        `Execution restricted for alias '${alias}'. Use FORCE=1 to override.`
      );
      process.exit(1);
    }

    for (const target of resolved.targets) {
      const result = spawnSync(target, args, {
        stdio: "inherit",
        shell: true,
      });

      if (result.status !== 0) {
        console.warn(
          `[WARN] Alias '${alias}' target failed: ${target}`
        );
        hadWarnings = true;
      }
    }

    writeExecutionEvidence(alias, hadWarnings ? "PASS_WITH_WARN" : "PASS");
  } catch (err) {
    console.error(`ERROR: ${err.message}`);
    process.exit(1);
  }
}

function writeExecutionEvidence(alias, status) {
  const entry = {
    alias,
    status,
    timestamp: new Date().toISOString(),
  };

  fs.mkdirSync("alias_softfocus/status", { recursive: true });
  fs.appendFileSync(
    "alias_softfocus/status/execution.log",
    JSON.stringify(entry) + "\n"
  );
}

function listAliases() {
  const raw = fs.readFileSync("docs/control/ALIASES.yaml", "utf8");
  const names = raw
    .split("\n")
    .filter((l) => l.startsWith("  ") && l.trim().endsWith(":"))
    .map((l) => l.trim().replace(":", ""));

  console.log("Available SoftFocus aliases:");
  names.forEach((a) => console.log(" ", a));
}

function docsStub() {
  console.log(
    "[INFO] docs command is available but operates in stub mode (Phase A/B)."
  );
  process.exit(0);
}

function usage() {
  console.log(`
Usage:
  alias-softfocus run <alias>
  alias-softfocus list
  alias-softfocus docs
`);
}
