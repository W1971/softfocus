#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
BIN_DIR="$ROOT/alias_softfocus/bin"
STATUS_DIR="$ROOT/alias_softfocus/status"
DOCS_DIR="$ROOT/docs"

run() {
  if [ "${DRY_RUN:-0}" = "1" ]; then
    echo "[DRY_RUN] $*"
  else
    "$@"
  fi
}

list_cmd() {
  echo "Available SoftFocus commands:"
  for f in "$BIN_DIR"/*; do
    [ -x "$f" ] || continue
    name="$(basename "$f")"
    [ "$name" = "alias-softfocus" ] && continue

    status_file="$STATUS_DIR/$name.status"
    if [ -f "$status_file" ]; then
      state="$(grep derived_state "$status_file" | awk '{print $2}')"
      echo "  $name [$state]"
    else
      echo "  $name [UNKNOWN]"
    fi
  done
}

docs_overview() {
  echo "SoftFocus Documentation Layers"
  echo "=============================="
  echo

  for layer in control frontend business governance internal engineering operations policy releases; do
    if [ -d "$DOCS_DIR/$layer" ]; then
      count="$(find "$DOCS_DIR/$layer" -type f | wc -l | tr -d ' ')"
      printf "%-12s %s files\n" "$layer/" "$count"
    fi
  done

  echo
  echo "Entry point:"
  echo "  docs/README.md"
}

docs_layer() {
  layer="${1:-}"
  if [ -z "$layer" ]; then
    docs_overview
    return
  fi

  target="$DOCS_DIR/$layer"
  if [ ! -d "$target" ]; then
    echo "Unknown docs layer: $layer"
    exit 1
  fi

  echo "Docs layer: $layer/"
  echo "---------------------"
  find "$target" -type f | sed "s|$DOCS_DIR/||" | sort
}

docs_tree() {
  layer="${1:-}"
  base="$DOCS_DIR"

  if [ -n "$layer" ]; then
    base="$DOCS_DIR/$layer"
    [ -d "$base" ] || { echo "Unknown docs layer: $layer"; exit 1; }
  fi

  echo "Docs tree: ${base#$DOCS_DIR/}"
  echo "----------------------------"
  find "$base" -type d | sed "s|$DOCS_DIR/||" | sort
}

docs_search() {
  term="${1:-}"
  if [ -z "$term" ]; then
    echo "Usage: alias-softfocus docs search <term>"
    exit 1
  fi

  echo "Searching docs for: \"$term\""
  echo "--------------------------------"
  grep -RIn "$term" "$DOCS_DIR" || echo "No matches found"
}

docs_cmd() {
  sub="${1:-}"
  case "$sub" in
    "")
      docs_overview
      ;;
    tree)
      shift || true
      docs_tree "$@"
      ;;
    search)
      shift
      docs_search "$@"
      ;;
    *)
      docs_layer "$sub"
      ;;
  esac
}

explain_cmd() {
  topic="${1:-}"
  if [ -z "$topic" ]; then
    echo "Usage: alias-softfocus explain <command>"
    exit 1
  fi

  case "$topic" in
    docs)
      cat <<'TXT'
alias-softfocus docs

Purpose:
  Inspect and navigate project documentation as a system.

Usage:
  alias-softfocus docs
  alias-softfocus docs <layer>
  alias-softfocus docs tree [layer]
  alias-softfocus docs search <term>
TXT
      ;;
    *)
      echo "No explanation available for: $topic"
      ;;
  esac
}

doctor_docs() {
  echo "Running docs diagnostics..."
  echo

  [ -d "$DOCS_DIR" ] && echo "✔ docs directory present"

  [ -f "$DOCS_DIR/README.md" ] \
    && echo "✔ docs/README.md present" \
    || echo "✖ docs/README.md missing"
}

doctor_cmd() {
  case "${1:-}" in
    --docs)
      doctor_docs
      ;;
    *)
      echo "Running SoftFocus diagnostics..."
      echo "✔ alias-softfocus available"
      ;;
  esac
}

case "${1:-}" in
  list)
    list_cmd
    ;;
  run)
    shift
    run "$@"
    ;;
  docs)
    shift || true
    docs_cmd "$@"
    ;;
  explain)
    shift
    explain_cmd "$@"
    ;;
  doctor)
    shift || true
    doctor_cmd "$@"
    ;;
  *)
    echo "Usage: alias-softfocus {list|run|docs|explain|doctor}"
    exit 1
    ;;
esac
