#!/usr/bin/env node

/**
 * SoftFocus â€” generate-status
 *
 * CI-oriented status aggregator.
 * Requires explicit RUN_ID.
 */

import fs from "fs";

const RUN_ID = process.env.RUN_ID;

if (!RUN_ID) {
  console.error("FAIL: RUN_ID is required");
  process.exit(1);
}

const EXEC_LOG = "alias_softfocus/status/execution.log";
const CLASSES_FILE = "docs/control/ALIAS_CLASSES.yaml";

/**
 * Load last execution status per alias
 */
function loadExecutionStatus() {
  if (!fs.existsSync(EXEC_LOG)) return {};
  const lines = fs.readFileSync(EXEC_LOG, "utf8").trim().split("\n");
  const map = {};
  for (const line of lines) {
    if (!line) continue;
    const entry = JSON.parse(line);
    map[entry.alias] = entry.status;
  }
  return map;
}

/**
 * Load alias classes
 */
function loadAliasClasses() {
  if (!fs.existsSync(CLASSES_FILE)) {
    console.error("FAIL: ALIAS_CLASSES.yaml missing");
    process.exit(1);
  }

  const lines = fs.readFileSync(CLASSES_FILE, "utf8").split("\n");
  const classes = {};

  for (const l of lines) {
    if (/^\s+[a-z0-9-]+:\s*(CORE|OPTIONAL|EXPERIMENTAL)\s*$/.test(l)) {
      const [name, cls] = l.trim().split(":").map(s => s.trim());
      classes[name] = cls;
    }
  }

  return classes;
}

const execStatus = loadExecutionStatus();
const aliasClasses = loadAliasClasses();

let overall = "READY";
const report = {};

for (const alias of Object.keys(aliasClasses)) {
  const cls = aliasClasses[alias];
  const status = execStatus[alias] || "UNKNOWN";

  report[alias] = { class: cls, status };

  if (cls === "CORE" && status !== "PASS") {
    overall = "FAIL";
  }
}

const result = {
  run_id: RUN_ID,
  overall,
  aliases: report,
};

console.log(JSON.stringify(result, null, 2));

if (overall === "FAIL") {
  process.exit(1);
}
