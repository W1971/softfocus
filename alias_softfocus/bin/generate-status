#!/usr/bin/env node
/**
 * generate-status v2
 * Phase B â€” deterministic, blocking readiness aggregator
 */

import fs from "fs";
import path from "path";
import yaml from "js-yaml";

const RUN_ID = process.argv[2];

const ALIASES_PATH = "docs/control/ALIASES.yaml";
const EXECUTION_LOG_PATH = "alias_softfocus/status/execution.log";
const OUTPUT_PATH = "alias_softfocus/status/derived-status.json";

failIf(!RUN_ID, "RUN_ID is required");
failIf(!fs.existsSync(ALIASES_PATH), "ALIASES.yaml missing");
failIf(!fs.existsSync(EXECUTION_LOG_PATH), "execution.log missing");

/* ---------- Load ALIASES.yaml ---------- */

const aliasesRaw = fs.readFileSync(ALIASES_PATH, "utf8");
const aliasesYaml = yaml.load(aliasesRaw);

if (!aliasesYaml || !aliasesYaml.aliases) {
  fail("Invalid ALIASES.yaml structure");
}

const controlledAliases = Object.entries(aliasesYaml.aliases)
  .filter(([, v]) => v.affects_readiness === true)
  .map(([k]) => k);

failIf(
  controlledAliases.length === 0,
  "No aliases affect readiness (misconfiguration)"
);

/* ---------- Load execution.log ---------- */

const executionLines = fs
  .readFileSync(EXECUTION_LOG_PATH, "utf8")
  .trim()
  .split("\n")
  .map((l) => JSON.parse(l));

/* ---------- Evaluate each alias ---------- */

for (const alias of controlledAliases) {
  const records = executionLines.filter(
    (r) => r.alias === alias && r.run_id === RUN_ID
  );

  if (records.length === 0) {
    fail(`Missing execution evidence for alias '${alias}'`);
  }

  const last = records[records.length - 1];

  if (last.status !== "PASS") {
    fail(
      `Alias '${alias}' reported status '${last.status}' (Phase B forbids WARN)`
    );
  }
}

/* ---------- SUCCESS ---------- */

const result = {
  run_id: RUN_ID,
  phase: "B",
  status: "READY",
  checked_aliases: controlledAliases,
  timestamp: new Date().toISOString(),
};

fs.mkdirSync(path.dirname(OUTPUT_PATH), { recursive: true });
fs.writeFileSync(OUTPUT_PATH, JSON.stringify(result, null, 2));

console.log(`RUN_ID: ${RUN_ID}`);
console.log(`Aliases checked: ${controlledAliases.length}`);
console.log("Result: READY");

process.exit(0);

/* ---------- Helpers ---------- */

function fail(message) {
  console.error(`FAIL: ${message}`);
  process.exit(1);
}

function failIf(condition, message) {
  if (condition) fail(message);
}

