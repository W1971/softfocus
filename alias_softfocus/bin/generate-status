#!/usr/bin/env node
/**
 * generate-status v2
 * Phase B â€” deterministic, blocking readiness aggregator
 */

import fs from "fs";
import path from "path";
import yaml from "js-yaml";

const RUN_ID = process.argv[2];

const ALIASES_PATH = "docs/control/ALIASES.yaml";
const RUNS_BASE = "tests/runs";
const OUTPUT_PATH = "alias_softfocus/status/derived-status.json";

if (!RUN_ID) fail("RUN_ID is required");

const RUN_DIR = path.join(RUNS_BASE, RUN_ID);
const RUN_LOG = path.join(RUN_DIR, "run.jsonl");

failIf(!fs.existsSync(ALIASES_PATH), "ALIASES file missing");
failIf(!fs.existsSync(RUN_LOG), `run.jsonl missing for RUN_ID=${RUN_ID}`);

/* ---------- Load aliases ---------- */

const aliasesYaml = yaml.load(fs.readFileSync(ALIASES_PATH, "utf8"));
failIf(!aliasesYaml || !aliasesYaml.aliases, "Invalid aliases schema");

const controlledAliases = Object.entries(aliasesYaml.aliases)
  .filter(([, v]) => v && v.affects_readiness === true)
  .map(([k]) => k);

failIf(controlledAliases.length === 0, "No readiness aliases defined");

/* ---------- Load run evidence ---------- */

const records = fs
  .readFileSync(RUN_LOG, "utf8")
  .trim()
  .split("\n")
  .map((l) => JSON.parse(l));

/* ---------- Evaluate ---------- */

for (const alias of controlledAliases) {
  const hits = records.filter(
    (r) => r.alias === alias && r.run_id === RUN_ID
  );

  if (hits.length === 0) {
    fail(`Missing execution evidence for alias '${alias}'`);
  }

  const last = hits[hits.length - 1];

  if (last.status !== "PASS") {
    fail(`Alias '${alias}' status=${last.status}`);
  }
}

/* ---------- SUCCESS ---------- */

const result = {
  run_id: RUN_ID,
  phase: "B",
  status: "READY",
  checked_aliases: controlledAliases,
  timestamp: new Date().toISOString(),
};

fs.mkdirSync(path.dirname(OUTPUT_PATH), { recursive: true });
fs.writeFileSync(OUTPUT_PATH, JSON.stringify(result, null, 2));

console.log(`RUN_ID: ${RUN_ID}`);
console.log(`Aliases checked: ${controlledAliases.length}`);
console.log("Result: READY");

process.exit(0);

/* ---------- Helpers ---------- */

function fail(msg) {
  console.error(`FAIL: ${msg}`);
  process.exit(1);
}

function failIf(cond, msg) {
  if (cond) fail(msg);
}
